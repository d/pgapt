#!/bin/sh

set -eu

[ "$USER" = "aptuser" ] || SUDO="sudo -u aptuser"
export REPREPRO_BASE_DIR="/srv/apt/repo"
REPREPRO="reprepro -b $REPREPRO_BASE_DIR --morguedir $REPREPRO_BASE_DIR/morgue --verbose"
DISTS="sid wheezy squeeze precise lucid"

while getopts "d:" opt ; do
	case $opt in
		d) DISTS="$OPTARG" ;;
		*) exit 5 ;;
	esac
done
# shift away args
shift $(($OPTIND - 1))

PKG="$1"

SOURCE=$($REPREPRO -A source list sid-pgdg-testing "$PKG")
if [ -z "$SOURCE" ]; then
	echo "ERROR: $PKG does not seem to be a source package"
	exit 1
fi

echo "reprepro ls $PKG"
$REPREPRO ls $PKG
OLDLS=$($REPREPRO -A source ls "$PKG" | grep -v pgdg-testing | column -t)
echo

for DIST in $DISTS ; do
	${SUDO:-} $REPREPRO copysrc $DIST-pgdg $DIST-pgdg-testing $PKG
done

echo
echo "reprepro ls $PKG"
$REPREPRO ls $PKG
NEWLS=$($REPREPRO -A source ls "$PKG" | grep -v pgdg-testing | column -t)
echo

if [ "$OLDLS" = "$NEWLS" ]; then
	echo "No change in the repository, not sending mail"
	exit
fi

NEWVERSION=$(echo "$SOURCE" | awk '{ print $3 }')
FROM="apt.postgresql.org repository <myon@debian.org>"
TO="PostgreSQL in Debian <pgsql-pkg-debian@postgresql.org>"

echo "Sending mail to $TO ..."

cat <<EOF | sendmail -t
From: $FROM
To: $TO
Subject: $PKG updated to version $NEWVERSION

The package $PKG was updated on apt.postgresql.org:

Old status:
$OLDLS

New status:
$NEWLS

EOF

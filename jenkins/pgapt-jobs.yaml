# defaults and macros

- defaults:
    name: global
    description: 'Do not edit this job through the web interface, it is generated via jenkins-job-builder!'
    logrotate:
        daysToKeep: -1
        numToKeep: 2
        artifactDaysToKeep: -1
        artifactNumToKeep: -1
    wrappers:
        - timestamps

# apt template

- job-template:
        name: '{name}-apt-source'
        job-name: '{name}-source'
        description: 'Build Debian source package of {name} from "apt-get source".<br />Do not edit this job through the web interface, it is generated via jenkins-job-builder!'
        project-type: matrix
        execution-strategy:
                sequential: true
                touchstone:
                        expr: 'distribution=="sid"'
        axes:
                - axis:
                        type: user-defined
                        name: distribution
                        values:
                                - sid
                                - wheezy
                                - squeeze
                                - trusty
                                - precise
                                - lucid
        builders:
                - shell: 'generate-pgdg-source'
        publishers:
                - archive:
                        artifacts: 'result/*'
                        latest-only: true
                - fingerprint:
                        record-artifacts: true
                - ircbot:
                        matrix-notifier: only-parent
                - trigger:
                        project: '{name}-binaries'

# bzr template

- job-template:
        name: '{name}-bzr-source'
        job-name: '{name}-source'
        description: 'Build Debian source package of {name} from bzr.<br />Do not edit this job through the web interface, it is generated via jenkins-job-builder!'
        project-type: matrix
        execution-strategy:
                sequential: true
                touchstone:
                        expr: 'distribution=="sid"'
        axes:
                - axis:
                        type: user-defined
                        name: distribution
                        values:
                                - sid
                                - wheezy
                                - squeeze
                                - trusty
                                - precise
                                - lucid
        scm:
                - bzr:
                        url: 'http://anonscm.debian.org/bzr/pkg-postgresql/{bzr-branch}/'
                        loggerhead: 'https://alioth.debian.org/scm/loggerhead/pkg-postgresql/{bzr-branch}'
        builders:
                - shell: 'generate-pgdg-source'
        publishers:
                - archive:
                        artifacts: 'result/*'
                        latest-only: true
                - fingerprint:
                        record-artifacts: true
                - ircbot:
                        matrix-notifier: only-parent
                - trigger:
                        project: '{name}-binaries'

# git template

- job-template:
        name: '{name}-git-source'
        job-name: '{name}-source'
        description: 'Build Debian source package of {name} from git.<br />Do not edit this job through the web interface, it is generated via jenkins-job-builder!'
        project-type: matrix
        execution-strategy:
                sequential: true
                touchstone:
                        expr: 'distribution=="sid"'
        axes:
                - axis:
                        type: user-defined
                        name: distribution
                        values:
                                - sid
                                - wheezy
                                - squeeze
                                - trusty
                                - precise
                                - lucid
        scm:
                - git:
                        url: '{git-url}'
                        branches:
                                - '{git-branch}'
                        basedir: source
                        wipe-workspace: false
        builders:
                - shell: 'generate-pgdg-source'
        publishers:
                - archive:
                        artifacts: 'result/*'
                        latest-only: true
                - fingerprint:
                        record-artifacts: true
                - ircbot:
                        matrix-notifier: only-parent
                - trigger:
                        project: '{name}-binaries'

# svn template

- job-template:
        name: '{name}-svn-source'
        job-name: '{name}-source'
        description: 'Build Debian source package of {name} from svn.<br />Do not edit this job through the web interface, it is generated via jenkins-job-builder!'
        project-type: matrix
        execution-strategy:
                sequential: true
                touchstone:
                        expr: 'distribution=="sid"'
        axes:
                - axis:
                        type: user-defined
                        name: distribution
                        values:
                                - sid
                                - wheezy
                                - squeeze
                                - trusty
                                - precise
                                - lucid
        scm:
                - svn:
                        url: '{svn-url}'
                        basedir: source
                        workspaceupdater: update
        builders:
                - shell: 'generate-pgdg-source'
        publishers:
                - archive:
                        artifacts: 'result/*'
                        latest-only: true
                - fingerprint:
                        record-artifacts: true
                - ircbot:
                        matrix-notifier: only-parent
                - trigger:
                        project: '{name}-binaries'

# binaries template

- job-template:
        name: '{name}-binaries'
        description: 'Build Debian binary package of {name}.<br />Do not edit this job through the web interface, it is generated via jenkins-job-builder!'
        project-type: matrix
        execution-strategy:
                touchstone:
                        expr: '(distribution=="sid") && (architecture=="amd64")'
        axes:
                - axis:
                        type: user-defined
                        name: architecture
                        values:
                                - amd64
                                - i386
                - axis:
                        type: user-defined
                        name: distribution
                        values:
                                - sid
                                - wheezy
                                - squeeze
                                - trusty
                                - precise
                                - lucid
        builders:
                - shell: 'rm -rf *'
                - copyartifact:
                        project: '{name}-source/distribution=$distribution'
                        filter: 'result/*'
                        flatten: true
                        which-build: upstream-build
                        fallback-to-last-successful: true
                - shell: 'BUILD_ONLY=yes build-and-provide-package'
        publishers:
                - archive:
                        artifacts: '*.gz,*.bz2,*.xz,*.deb,*.dsc,*.changes'
                        latest-only: true
                - fingerprint:
                        record-artifacts: true
                - junit:
                        results: autopkgtest.xml
                - ircbot:
                        strategy: any-failure
                        message-type: summary
                        matrix-notifier: only-configurations
                - trigger-parameterized-builds:
                        - project: dput
                          condition: SUCCESS
                          predefined-parameters: 'binaries=$JOB_NAME'
                - workspace-cleanup

# job groups

- job-group:
        name: apt-packages
        jobs:
                - '{name}-apt-source'
                - '{name}-binaries'

- job-group:
        name: bzr-packages
        jobs:
                - '{name}-bzr-source'
                - '{name}-binaries'

- job-group:
        name: git-packages
        jobs:
                - '{name}-git-source'
                - '{name}-binaries'

- job-group:
        name: svn-packages
        jobs:
                - '{name}-svn-source'
                - '{name}-binaries'

# simple jobs

- job:
        name: apt.postgresql.org
        scm:
                - git:
                        url: git://git.postgresql.org/git/pgapt.git
                        branches:
                                - master
                        wipe-workspace: false
        builders:
                - shell: 'ssh atalia.postgresql.org "cd /srv/apt/apt.postgresql.org && sudo -u aptuser git pull"'
        publishers:
                - ircbot:
                        matrix-notifier: all

- job:
        name: dput
        logrotate:
                numToKeep: 10
        parameters:
                - string:
                        name: binaries
                        description: Name of binaries job to copy artifacts from
                - choice:
                        name: queue
                        choices:
                                - incoming
                                - private
                        description: Incoming queue to use
        builders:
                - shell: 'rm -rf *'
                - copyartifact:
                        project: '$binaries'
                        filter: '*.gz,*.bz2,*.xz,*.deb,*.dsc,*.changes'
                        flatten: true
                        which-build: upstream-build
                        fallback-to-last-successful: true
                - shell: 'dput-pgdg $queue'
        publishers:
                - ircbot:
                        matrix-notifier: all
                        message-type: summary-params

# project jobs

- project:
        name: apgdiff
        svn-url: svn://svn.debian.org/pkg-postgresql/trunk/apgdiff
        jobs:
                - svn-packages

- project:
        name: autopkgtest
        jobs:
                - apt-packages

- project:
        name: newpid
        git-url: https://github.com/ChristophBerg/newpid.git
        git-branch: master
        jobs:
                - git-packages

- project:
        name: postgresql-common
        bzr-branch: postgresql-common/trunk
        jobs:
                - bzr-packages

- project:
        name: postgresql-9.3
        bzr-branch: postgresql-9.3/trunk
        jobs:
                - bzr-packages

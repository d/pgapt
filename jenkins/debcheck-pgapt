#!/bin/sh

# expected parameters:
#   distribution (without -pgdg)
#   architecture
#   stage (testing or production)
# expected directories: chroots in /home/chroot
# needs dose3 >= 4

set -eu

error () {
  echo "Error: $@" >&2
  exit 2
}

: ${distribution:=sid} ${architecture:=amd64} ${stage:=testing}

LISTSDIR="/home/chroot/$distribution-$architecture/var/lib/apt/lists"
[ -d "$LISTSDIR" ] || error "$LISTSDIR not found"
HOMEDIR="/home/jenkins"

# where to find packages.backports
PGAPTDIR="$HOMEDIR/apt.postgresql.org/jenkins"
test -d $PGAPTDIR && cd $PGAPTDIR

if [ -d ../repo/dists ]; then
  DISTSDIR="../repo/dists"
elif [ -d "$HOMEDIR/dists" ]; then
  DISTSDIR="$HOMEDIR/dists"
else
  error "No dists directory found."
fi

case $stage in
	production) DIST="$distribution-pgdg" ;;
	testing)    DIST="$distribution-pgdg-testing" ;;
	*) error "Bad stage $stage" ;;
esac

trap 'rm -f ${MAINPKG:-} ${BPOPKG:-}' 0 2 3 15

# include universe on ubuntu
for FILE in $LISTSDIR/*_dists_${distribution}_universe_binary-${architecture}_Packages ; do
  [ -f "$FILE" ] || continue
  EXTRABG="--bg $FILE"
done

# include latest N.N components on sid
case $distribution in
	sid)
		C=$(ls -d $DISTSDIR/$DIST/?.? | tail -n 1)
		test -s $C/binary-${architecture}/Packages && \
		EXTRAFG="--fg $C/binary-${architecture}/Packages"
	;;
esac

DEBCHECK="dose-debcheck -v -f -e ${EXTRABG:-} --bg $LISTSDIR/*_dists_${distribution}_main_binary-${architecture}_Packages"

# packages not depending on backports
MAINPKG=$(mktemp main_binary-${architecture}_Packages.XXXXXX)
cat $DISTSDIR/$DIST/main/binary-${architecture}/Packages > $MAINPKG

# packages not tested in production
if [ "$stage" = "production" ]; then
  for pkg in cl-pgloader; do
    grep-dctrl --not -P $pkg $MAINPKG > $MAINPKG.tmp
    mv $MAINPKG.tmp $MAINPKG
  done
fi

case $distribution in
  squeeze|wheezy|jessie)
    for pkg in $(cat packages.backports); do
      grep-dctrl --not -S $pkg $MAINPKG > $MAINPKG.tmp
      mv $MAINPKG.tmp $MAINPKG
    done

    # packages depending on backports
    BPOPKG=$(mktemp bpo_binary-${architecture}_Packages.XXXXXX)
    for pkg in $(cat packages.backports); do
      grep-dctrl -S $pkg $DISTSDIR/$DIST/main/binary-${architecture}/Packages >> $BPOPKG || :
    done
    ;;
esac

set -x

# run debcheck on main
$DEBCHECK ${EXTRAFG:-} --fg $MAINPKG || EXIT=$?
test -s "${BPOPKG:-}" && { \
$DEBCHECK ${EXTRAFG:-} --bg $DISTSDIR/$DIST/main/binary-${architecture}/Packages \
  --bg $LISTSDIR/../backports/*_dists_${distribution}-backports_main_binary-${architecture}_Packages \
  --fg $BPOPKG || EXIT=$? ; }

# run debcheck on N.N components
for P in $DISTSDIR/$DIST/?.?/binary-${architecture}/Packages; do
	test -s $P && PKG="${PKG:-} $P"
done
if [ "${PKG:-}" ]; then
  $DEBCHECK \
    --bg $DISTSDIR/$DIST/main/binary-${architecture}/Packages \
    --fg $PKG || EXIT=$?
fi

exit ${EXIT:-0}
